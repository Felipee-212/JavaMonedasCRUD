<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Monedas CRUD Simple</title>
</head>
<body>

<h2>Monedas</h2>

<button onclick="mostrarAgregar()">Agregar moneda</button>

<!-- form  -->
<div id="formDiv" style="margin-top:10px; display:none;">
    <input id="id" type="hidden">


    Fecha: <input id="fecha"><br>
    País: <input id="pais"><br>
    Año: <input id="anio"><br>
    Nominal: <input id="nominal"><br>
    Compra: <input id="compra"><br>
    Mercado: <input id="mercado"><br>

    <button onclick="guardar()">Guardar</button>
    <button onclick="cancelar()">Cancelar</button>
</div>

<!-- tabla -->
<table border="1" style="margin-top:20px;">
    <thead>
    <tr>
        <th>ID</th>
        <th>Fecha</th>
        <th>País</th>
        <th>Año</th>
        <th>Nominal</th>
        <th>Compra</th>
        <th>Mercado</th>
        <th>Acciones</th>
    </tr>
    </thead>
    <tbody id="tbody"></tbody>
</table>

<script>
    const API = "http://localhost:8080/monedas";

    // agarro referencias para no repetir document.getElement
    const f = document.getElementById("fecha");
    const p = document.getElementById("pais");
    const a = document.getElementById("anio");
    const n = document.getElementById("nominal");
    const c = document.getElementById("compra");
    const m = document.getElementById("mercado");
    const formDiv = document.getElementById("formDiv");
    const idInput = document.getElementById("id");
    const tbody = document.getElementById("tbody");

    // acá guardo si estoy editando o no
    let editId = null;

    // limpia el form siempre que entro a agregar
    function limpiarFormulario() {
        idInput.value = "";
        f.value = "";
        p.value = "";
        a.value = "";
        n.value = "";
        c.value = "";
        m.value = "";
    }

    // muestro el form para agregar una moneda nueva
    function mostrarAgregar(){
        limpiarFormulario();
        formDiv.style.display = "block";
        editId = null;        // indico que no estoy editando
    }

    // ocultar form sin guardar
    function cancelar(){
        limpiarFormulario();
        formDiv.style.display = "none";
        editId = null;
    }

    // cargo las monedas cuando arranca
    async function cargar(){
        const resp = await fetch(API + "/listar");
        const data = await resp.json();
        renderTabla(data);
    }

    // render de la tabla
    function renderTabla(monedas){
        tbody.innerHTML = "";

        monedas.forEach(mo => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
            <td>${mo.id}</td>
            <td>${(mo.fechaRegistro || "").substring(0,10)}</td>
            <td>${mo.pais}</td>
            <td>${mo.anioDePublicacion}</td>
            <td>${mo.valorNominal}</td>
            <td>${mo.precioCompra}</td>
            <td>${mo.valorMercado}</td>
            <td>
                <button onclick="editar(${mo.id})">Editar</button>
                <button onclick="eliminar(${mo.id})">Eliminar</button>
            </td>
        `;

            tbody.appendChild(tr);
        });
    }

    // cuando toco editar, lleno el form con los datos
    async function editar(id){
        const resp = await fetch(API + "/listar");
        const arr = await resp.json();
        const mo = arr.find(x => x.id === id);

        if (!mo) return;

        // pongo los datos en el form
        idInput.value = mo.id;
        f.value = mo.fechaRegistro ? mo.fechaRegistro.substring(0,10) : "";
        p.value = mo.pais;
        a.value = mo.anioDePublicacion;
        n.value = mo.valorNominal;
        c.value = mo.precioCompra;
        m.value = mo.valorMercado;

        // muestro el form
        formDiv.style.display = "block";
        editId = id;
    }

    // guardar  POST o PUT según editId
    async function guardar(){
        const obj = {
            fechaRegistro: f.value,
            pais: p.value,
            anioDePublicacion: parseInt(a.value),
            valorNominal: n.value,
            precioCompra: parseFloat(c.value),
            valorMercado: parseFloat(m.value)
        };

        if (!editId){
            // crear moneda nueva
            await fetch(API + "/agregar", {
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body: JSON.stringify(obj)
            });
        } else {
            // actualizar existente
            await fetch(API + "/modificar/" + editId, {
                method:"PUT",
                headers:{ "Content-Type":"application/json" },
                body: JSON.stringify(obj)
            });
        }

        limpiarFormulario();
        formDiv.style.display = "none";
        editId = null;

        cargar();
    }

    // eliminar una moneda
    async function eliminar(id){
        await fetch(API + "/elminiar/" + id, { method:"DELETE" });
        cargar();
    }

    cargar(); // arranca la app
</script>

</body>
</html>
